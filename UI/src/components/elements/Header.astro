---
import Navitem from "../shared/Navitem.astro";
import { LogoTitle } from "@components/blocks";
import { routes } from "@routes/mainNavigation";
const activeRoutes = routes.filter((route) => route.isActive);
---

<header class="fixed inset-x-0 top-0 z-[70] bg-body border-b border-box-border">
  <nav class="mx-auto w-full max-w-7xl flex items-center justify-between gap-6 px-4 py-3">
    <!-- Logo -->
    <a href="/" class="flex items-center gap-3">
      <LogoTitle size="sm" />
    </a>

    <!-- Desktop nav -->
    <ul class="hidden lg:flex items-center gap-4 text-lg text-heading-2">
      {activeRoutes.map((item) => <Navitem {...item} />)}
    </ul>

    <!-- Hamburger (mobile only) -->
    <button
      id="nav-toggle"
      class="lg:hidden inline-flex items-center justify-center p-2 rounded-md border border-box-border text-heading-2"
      aria-controls="mobile-menu"
      aria-expanded="false"
      aria-label="Toggle menu"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
  </nav>

  <!-- Mobile menu (hidden by default) -->
  <div
    id="mobile-menu"
    class="lg:hidden hidden fixed inset-x-0 z-[60] bg-body border-t border-box-border shadow-xl"
    style="top: 0px;"  <!-- JS sets this to header height -->
  >
    <ul class="flex flex-col gap-4 p-4 text-lg text-heading-2">
      {activeRoutes.map((item) => <Navitem {...item} />)}
    </ul>
  </div>

  <!-- Overlay: below menu, below header -->
  <div
    id="nav-overlay"
    class="hidden lg:hidden fixed inset-x-0 bottom-0 bg-black/40 backdrop-blur-sm z-[50]"
    style="top: 0px;"  <!-- JS sets this to header height -->
    aria-hidden="true"
  ></div>
</header>

<script is:raw>
(() => {
  const header  = document.querySelector('header');
  const toggle  = document.getElementById('nav-toggle');
  const menu    = document.getElementById('mobile-menu');
  const overlay = document.getElementById('nav-overlay');

  function headerHeight() {
    return header ? header.offsetHeight : 0;
  }

  function positionPanels() {
    const top = headerHeight();
    if (menu)    menu.style.top    = top + 'px';
    if (overlay) overlay.style.top = top + 'px';
  }

  function setOpen(open) {
    if (!menu || !overlay || !toggle) return;
    menu.classList.toggle('hidden', !open);
    overlay.classList.toggle('hidden', !open);
    toggle.setAttribute('aria-expanded', String(open));
    document.body.classList.toggle('overflow-hidden', open);
  }

  // Toggle menu
  toggle?.addEventListener('click', () => {
    const willOpen = menu.classList.contains('hidden');
    setOpen(willOpen);
  });

  // Close on overlay click
  overlay?.addEventListener('click', () => setOpen(false));

  // Close on nav link click (mobile only)
  menu?.querySelectorAll('a[href^="#"]').forEach(link => {
    link.addEventListener('click', () => setOpen(false));
  });

  // Resize handling
  const sync = () => {
    positionPanels();
    if (window.matchMedia('(min-width: 1024px)').matches) setOpen(false);
  };

  document.addEventListener('astro:page-load', sync);
  window.addEventListener('resize', sync);
  window.addEventListener('load', positionPanels);
  positionPanels();
})();
</script>
